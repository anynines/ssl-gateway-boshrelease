#!/bin/bash -e

PIDFILE=/var/vcap/packages/nginx/logs/nginx.pid

mkdir -p /var/vcap/sys/run/nginx
mkdir -p /var/vcap/sys/log/nginx
mkdir -p /var/vcap/jobs/nginx/etc
mkdir -p /var/vcap/store/nginx/conf.d
mkdir -p /var/vcap/store/nginx/sites-enabled
mkdir -p /var/vcap/store/nginx/sites-available
mkdir -p /var/vcap/store/nginx/ssl
mkdir -p /var/vcap/store/nginx/static

cp /var/vcap/jobs/nginx/etc/nginx.conf /var/vcap/store/nginx/
cp /var/vcap/jobs/nginx/etc/upstream.conf /var/vcap/store/nginx/conf.d/
cp /var/vcap/jobs/nginx/etc/shared.conf /var/vcap/store/nginx/static/
cp /var/vcap/jobs/nginx/etc/shared_host_wss.conf /var/vcap/store/nginx/static/
cp /var/vcap/jobs/nginx/etc/ssh-proxy.conf /var/vcap/store/nginx/
cp /var/vcap/jobs/nginx/etc/default-location-header.conf /var/vcap/store/nginx/
cp /var/vcap/jobs/nginx/etc/maps.conf /var/vcap/store/nginx/
cp /var/vcap/jobs/nginx/etc/default-ssl.conf /var/vcap/store/nginx/
cp /var/vcap/jobs/nginx/etc/default-vserver.conf /var/vcap/store/nginx/
cp /var/vcap/jobs/nginx/etc/tcp-redirect.conf /var/vcap/store/nginx/

<% if p('a9s_ssl_gateway.enable_https_redirect') %>
cp /var/vcap/jobs/nginx/etc/https-redirect.conf /var/vcap/store/nginx/conf.d
<% end %>

<% p('a9s_ssl_gateway.vserver').each do |vserver| %>
  <% if (vserver.key?("certificate") && vserver.key?("ca") && vserver.key?("private_key")) %>
>/var/vcap/store/nginx/ssl/wild.<%= vserver["domain"] %>.crt.bundle
echo "<%= vserver["certificate"] %>" >> /var/vcap/store/nginx/ssl/wild.<%= vserver["domain"] %>.crt.bundle
echo "<%= vserver["ca"] %>" >> /var/vcap/store/nginx/ssl/wild.<%= vserver["domain"] %>.crt.bundle

>/var/vcap/store/nginx/ssl/wild.<%= vserver["domain"] %>.key
echo "<%= vserver["private_key"] %>" >> /var/vcap/store/nginx/ssl/wild.<%= vserver["domain"] %>.key
  <% end %>
<% end %>

cp /var/vcap/jobs/nginx/etc/vserver.conf /var/vcap/store/nginx/conf.d/vserver.conf

case $1 in

  start)

    /var/vcap/packages/nginx/sbin/nginx -g "pid $PIDFILE;" -c /var/vcap/store/nginx/nginx.conf
    ;;
  stop)
    kill $(cat $PIDFILE)
    ;;
  *)
    echo "Usage: ctl {start|stop}"
    ;;
esac
