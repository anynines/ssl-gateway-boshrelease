#!/bin/bash -e
<% cf_app_domain = p('a9s_ssl_gateway.default_apps_domain') %>
<% domain_blacklist = p('a9s_ssl_gateway.domain_blacklist') %>


PIDFILE=/var/vcap/packages/nginx/logs/nginx.pid

mkdir -p /var/vcap/sys/run/nginx
mkdir -p /var/vcap/sys/log/nginx
mkdir -p /var/vcap/jobs/nginx/etc
mkdir -p /var/vcap/store/nginx/conf.d
mkdir -p /var/vcap/store/nginx/sites-enabled
mkdir -p /var/vcap/store/nginx/sites-available
mkdir -p /var/vcap/store/nginx/ssl
mkdir -p /var/vcap/store/nginx/static

cp /var/vcap/jobs/nginx/etc/nginx.conf /var/vcap/store/nginx/
cp /var/vcap/jobs/nginx/etc/cf-default-apps-domain.conf /var/vcap/store/nginx/conf.d/
cp /var/vcap/jobs/nginx/etc/upstream.conf /var/vcap/store/nginx/conf.d/
cp /var/vcap/jobs/nginx/etc/shared.conf /var/vcap/store/nginx/static/
cp /var/vcap/jobs/nginx/etc/shared_host_wss.conf /var/vcap/store/nginx/static/
cp /var/vcap/jobs/nginx/etc/ssh-proxy.conf /var/vcap/store/nginx/

<% if domain_blacklist.to_s.empty? %>
  <% domain_blacklist.each do |blacklisted_domain| %>
    <% if (blacklisted_domain.key?("certificate") && blacklisted_domain.key?("ca") && blacklisted_domain.key?("private_key")) %>
>/var/vcap/store/nginx/ssl/wild.<%= blacklisted_domain["domain"] %>.crt.bundle
echo "<%= blacklisted_domain["certificate"] %>" >> /var/vcap/store/nginx/ssl/wild.<%= blacklisted_domain["domain"] %>.crt.bundle
echo "<%= blacklisted_domain["ca"] %>" >> /var/vcap/store/nginx/ssl/wild.<%= blacklisted_domain["domain"] %>.crt.bundle

>/var/vcap/store/nginx/ssl/wild.<%= blacklisted_domain["domain"] %>.key
echo "<%= blacklisted_domain["private_key"] %>" >> /var/vcap/store/nginx/ssl/wild.<%= blacklisted_domain["domain"] %>.key
    <% end %>
  <% end %>
<% end %>

cp /var/vcap/jobs/nginx/etc/blacklist-app-domains.conf /var/vcap/store/nginx/conf.d/blacklist-app-domains.conf
cp /var/vcap/jobs/nginx/etc/cf-default-apps-domain.conf /var/vcap/store/nginx/conf.d/<%= cf_app_domain %>.conf
cp /var/vcap/jobs/nginx/etc/cf-default-apps-domain-cert.crt.bundle /var/vcap/store/nginx/ssl/wild.<%= cf_app_domain %>.crt.bundle
cp /var/vcap/jobs/nginx/etc/cf-default-apps-domain-cert.key /var/vcap/store/nginx/ssl/wild.<%= cf_app_domain %>.key

case $1 in

  start)

    /var/vcap/packages/nginx/sbin/nginx -g "pid $PIDFILE;" -c /var/vcap/store/nginx/nginx.conf
    ;;
  stop)
    kill $(cat $PIDFILE)
    ;;
  *)
    echo "Usage: ctl {start|stop}"
    ;;
esac
