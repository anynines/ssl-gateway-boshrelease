name: ssl-gateway

manifest_version: 2.0.0

addons:
- name: bpm
  jobs:
  - name: bpm
    release: bpm

update:
  canaries: 1
  canary_watch_time: 1000-180000
  max_in_flight: 50
  serial: true
  update_watch_time: 1000-180000

stemcells:
- os: ubuntu-jammy
  alias: ubuntu-jammy
  version: ((iaas.stemcells.ubuntu-jammy.version))

releases:
- name: ssl-gateway
  version: 13+dev.10
  url: /u/a9s/yby/ssl-gateway-v2/ssl-gateway-v13+dev.10.tgz
  sha1: sha256:db8e05a9ea454c9737f53417f0f195204be7e6a3b4ed853362118f54d426cc84
- name: rabbitmq310
  version: 2.29.0
  url: https://d3r5lzz0qww9ge.cloudfront.net/rabbitmq310-2.29.0.tgz
  sha1: sha256:fc0c815d159885601e61dc657cb885aee433ee4442ce131a1b9d16e5d0756340
- name: a9s-consul
  url: https://d3r5lzz0qww9ge.cloudfront.net/a9s-consul-37.tgz
  version: 37
  sha1: sha256:f9ddc2e752366059087171d3030778231b7730e18689a178557041d1899d4fd0
- name: bpm
  version: 1.2.4
  url: https://bosh.io/d/github.com/cloudfoundry/bpm-release?v=1.2.4
  sha1: 52c90ab6a217a77bf03b1383606557c0f56d5d8c
- name: haproxy
  version: 12.1.0+2.7.7
  url: https://github.com/cloudfoundry/haproxy-boshrelease/releases/download/v12.1.0+2.7.7/haproxy-12.1.0+2.7.7.tgz
  sha1: f20937de3035567f07e76d72a5e5786b6cf368df

instance_groups:
- name: rabbitmq
  vm_type: small
  instances: 1
  azs: [z1, z2, z3]
  stemcell: ubuntu-jammy
  persistent_disk_type: small
  jobs:
  - name: rabbitmq
    release: rabbitmq310
    properties:
      rabbitmq:
        admin_username: admin
        admin_password: "((ssl_gw_rabbitmq_password))"
        host: ssl-gateway-rabbitmq-0.node.dc1.((iaas.consul.domain))
      consul:
        domain: "((iaas.consul.domain))"
        dc: dc1
        agent_address: 127.0.0.1:8500
  - name: consul
    release: a9s-consul
    consumes:
      consul_nodes: nil
    properties:
      consul:
        domain: "((iaas.consul.domain))"
        dc: dc1
        agent_address: 127.0.0.1:8500
        server: false
        encrypt: "((/cdns_encrypt))"
        cluster:
          join_hosts: "((iaas.consul.consul_ips))"
        ssl_ca: "((/cdns_ssl.ca))"
        ssl_cert: "((/cdns_ssl.certificate))"
        ssl_key: "((/cdns_ssl.private_key))"
        service_name: rabbitmq
  networks:
  - name: dynamic

- name: ssl-gateway
  vm_type: small
  instances: "((iaas.ssl_gateway.gateway_instances))"
  azs: [z1, z2, z3]
  stemcell: ubuntu-jammy
  persistent_disk_type: small
  jobs:
  - name: consul
    release: a9s-consul
    consumes:
      consul_nodes: nil
    properties:
      consul:
        domain: "((iaas.consul.domain))"
        dc: dc1
        agent_address: 127.0.0.1:8500
        server: false
        encrypt: "((/cdns_encrypt))"
        cluster:
          join_hosts: "((iaas.consul.consul_ips))"
        ssl_ca: "((/cdns_ssl.ca))"
        ssl_cert: "((/cdns_ssl.certificate))"
        ssl_key: "((/cdns_ssl.private_key))"
  - name: haproxy
    release: haproxy
    properties:
      ha_proxy:
        additional_unrestricted_volumes:
        - path: /var/vcap/store/virtual_host_service_worker/
          writable: true
        ext_crt_list: true
        ext_crt_list_file: /var/vcap/store/virtual_host_service_worker/haproxy-certificate-list
        ext_crt_list_policy: continue
  - name: virtual_host_service_worker
    release: ssl-gateway
    properties:
      a9s_ssl_gateway:
        cf_routers: "((iaas.cf.router_ips))"
      rabbitmq:
        admin_username: admin
        admin_password: "((ssl_gw_rabbitmq_password))"
        host: ssl-gateway-rabbitmq-0.node.dc1.((iaas.consul.domain))
  networks:
  - name: dynamic

- name: gateway-api
  vm_type: small
  instances: 1
  azs: [z1, z2, z3]
  stemcell: ubuntu-jammy
  persistent_disk_type: small

  jobs:
  - name: consul
    release: a9s-consul
    consumes:
      consul_nodes: nil
    properties:
      consul:
        domain: "((iaas.consul.domain))"
        dc: dc1
        agent_address: 127.0.0.1:8500
        server: false
        encrypt: "((/cdns_encrypt))"
        cluster:
          join_hosts: "((iaas.consul.consul_ips))"
        ssl_ca: "((/cdns_ssl.ca))"
        ssl_cert: "((/cdns_ssl.certificate))"
        ssl_key: "((/cdns_ssl.private_key))"
        service_name: vhost-api
  - name: virtual_host_service_api
    release: ssl-gateway
    properties:
      vhost_api:
        postgresql_host: a9s-pg-psql-master-alias.node.dc1.((iaas.consul.domain))
        postgresql_db: sslgateway
        postgresql_username: sslgateway
        postgresql_password: "((/a9s_pg_sslgateway_db_password))"
        customer_panel_secret: "((ssl_gw_customerpanel_secret))"
        port: 3000
      rabbitmq:
        admin_username: admin
        admin_password: "((ssl_gw_rabbitmq_password))"
        host: ssl-gateway-rabbitmq-0.node.dc1.((iaas.consul.domain))

  networks:
  - name: dynamic

variables:
- name: ssl_gw_customerpanel_secret
  type: password
- name: ssl_gw_rabbitmq_password
  type: password
